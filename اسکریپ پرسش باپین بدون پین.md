import os
import base64
import json
import re
import subprocess
from urllib.parse import urlparse, parse_qs, unquote
from rich import print

def remove_emojis(text):
    emoji_pattern = re.compile(
        "["
        "\U0001F600-\U0001F64F" 
        "\U0001F300-\U0001F5FF" 
        "\U0001F680-\U0001F6FF" 
        "\U0001F1E0-\U0001F1FF" 
        "\U00002700-\U000027BF" 
        "\U0001F900-\U0001F9FF" 
        "\U00002600-\U000026FF"
        "]+", flags=re.UNICODE)
    return emoji_pattern.sub(r'', text)

def extract_host(config):
    match = re.search(r"@([^:/?#]+)", config)
    return match.group(1) if match else None

def ping_host(host):
    try:
        output = subprocess.check_output(
            ["ping", "-c", "3", "-W", "1", host],
            stderr=subprocess.DEVNULL
        ).decode()
        match = re.search(r"rtt min/avg/max/mdev = [\d.]+/([\d.]+)", output)
        return float(match.group(1)) if match else None
    except:
        return None

def classify_ping(ping):
    if ping is None:
        return "bad", "[bold red][BAD][/bold red]"
    elif ping < 150:
        return "good", "[bold green][GOOD][/bold green]"
    elif ping < 300:
        return "warn", "[bold yellow][WARN][/bold yellow]"
    else:
        return "bad", "[bold red][BAD][/bold red]"

def parse_config_line(config, index):
    protocol = "vmess"
    server = "example.com"
    port = "443"
    uuid = "00000000-0000-0000-0000-000000000000"
    name = f"proxy{index}"
    tls = False
    network = "tcp"
    password = ""
    extra = {}

    config = config.strip()
    proto_match = re.match(r"^(vmess|vless|trojan|ss|shadowsocks)://", config, re.I)
    if proto_match:
        protocol = proto_match.group(1).lower()

    try:
        if protocol == "vmess":
            decoded = base64.b64decode(config[len("vmess://"):].strip() + "===").decode(errors="ignore")
            data = json.loads(decoded)
            server = data.get("add", server)
            port = str(data.get("port", port))
            uuid = data.get("id", uuid)
            name = data.get("ps", name)
            tls = data.get("tls", "none") != "none"
            network = data.get("net", "tcp")
        elif protocol in ["vless", "trojan"]:
            parsed = urlparse(config)
            server = parsed.hostname or server
            port = str(parsed.port or port)
            uuid = parsed.username or uuid
            name = unquote(parsed.fragment or name)
            params = parse_qs(parsed.query)
            tls = params.get("security", ["none"])[0] == "tls"
            network = params.get("type", [network])[0]
            extra = {
                "servername": params.get("sni", [""])[0],
                "alpn": params.get("alpn", []),
                "skip-cert-verify": params.get("skip-cert-verify", ["false"])[0] == "true",
                "udp": True
            }
        elif protocol in ["ss", "shadowsocks"]:
            name = unquote(urlparse(config).fragment or name)
            server = urlparse(config).hostname or server
            port = str(urlparse(config).port or port)
            extra["password"] = urlparse(config).password or ""
    except Exception as e:
        print(f"[bold red]Error parsing config {index}: {e}[/bold red]")

    return {
        "name": name,
        "type": protocol,
        "server": server,
        "port": int(port),
        "uuid": uuid,
        "tls": tls,
        "network": network,
        **extra
    }

def convert_to_clash_yaml(configs):
    proxies = []
    names_seen = set()

    for idx, config in enumerate(configs, 1):
        proxy = parse_config_line(config, idx)

        original_name = proxy["name"]
        count = 1
        while proxy["name"] in names_seen:
            proxy["name"] = f"{original_name}_{count}"
            count += 1
        names_seen.add(proxy["name"])

        lines = [
            f"  - name: \"{proxy['name']}\"",
            f"    type: {proxy['type']}",
            f"    server: {proxy['server']}",
            f"    port: {proxy['port']}",
        ]
        if proxy["type"] in ["vmess", "vless"]:
            lines.append(f"    uuid: {proxy['uuid']}")
        if proxy.get("password"):
            lines.append(f"    password: {proxy['password']}")
        if proxy["type"] != "ss":
            lines.append(f"    network: {proxy['network']}")
            lines.append(f"    tls: {str(proxy['tls']).lower()}")
        if proxy.get("servername"):
            lines.append(f"    servername: {proxy['servername']}")
        if proxy.get("alpn"):
            lines.append(f"    alpn: {json.dumps(proxy['alpn'])}")
        if proxy.get("skip-cert-verify") is not None:
            lines.append(f"    skip-cert-verify: {str(proxy['skip-cert-verify']).lower()}")
        if proxy.get("udp"):
            lines.append(f"    udp: true")

        proxies.append("\n".join(lines))

    return "proxies:\n" + "\n\n".join(proxies)

def main():
    print("[bold cyan]Enter your configs (press Enter on empty line to finish):[/bold cyan]")
    all_configs = []
    while True:
        try:
            line = input()
            if not line.strip():
                break
            all_configs.append(line.strip())
        except KeyboardInterrupt:
            break

    if not all_configs:
        print("[bold red]No configs entered.[/bold red]")
        return

    print("\n[bold magenta]Choose mode:[/bold magenta]")
    print("1) Filter only GOOD configs by ping")
    print("2) Process all configs without ping check")
    mode = input("[bold yellow]Enter 1 or 2:[/bold yellow] ").strip()

    final_configs = []
    if mode == "1":
        for config in all_configs:
            host = extract_host(config)
            if not host:
                continue
            ping = ping_host(host)
            status, label = classify_ping(ping)
            print(f"{label} {host} - {ping if ping else 'NO REPLY'}ms")
            if status == "good":
                final_configs.append(config)
    else:
        final_configs = all_configs

    if not final_configs:
        print("[bold red]No valid configs found to save.[/bold red]")
        return

    while True:
        print("\n[bold green]Output Options:[/bold green]")
        print("1) Show configs")
        print("2) Save as TXT")
        print("3) Save as Base64 (per line)")
        print("4) Save as Full Base64 (combined)")
        print("5) Save as Clash YAML")
        print("6) Save as JSON proxies list")

        choice = input("[bold yellow]Select option (1-6):[/bold yellow] ").strip()

        folder = "/storage/emulated/0/Download/tepo98"
        os.makedirs(folder, exist_ok=True)

        if choice == "1":
            print("\n[bold blue]Configs:[/bold blue]")
            for conf in final_configs:
                print(conf)
        elif choice == "2":
            name = input("Enter file name: ").strip()
            with open(os.path.join(folder, name), "w") as f:
                f.write("\n".join(final_configs))
            print(f"[cyan]Saved to {folder}/{name}[/cyan]")
        elif choice == "3":
            name = input("Enter file name: ").strip()
            with open(os.path.join(folder, name), "w") as f:
                for conf in final_configs:
                    f.write(base64.b64encode(conf.encode()).decode() + "\n")
            print(f"[cyan]Saved to {folder}/{name}[/cyan]")
        elif choice == "4":
            name = input("Enter file name: ").strip()
            combined = base64.b64encode("\n".join(final_configs).encode()).decode()
            with open(os.path.join(folder, name), "w") as f:
                f.write(combined)
            print(f"[cyan]Saved to {folder}/{name}[/cyan]")
        elif choice == "5":
            name = input("Enter YAML file name: ").strip()
            yaml_data = convert_to_clash_yaml(final_configs)
            with open(os.path.join(folder, name), "w") as f:
                f.write(yaml_data)
            print(f"[cyan]Saved to {folder}/{name}[/cyan]")
        elif choice == "6":
            name = input("Enter JSON file name: ").strip()
            proxies = []
            for i, c in enumerate(final_configs, 1):
                proxy = parse_config_line(c, i)
                base_name = remove_emojis(proxy["name"]).strip()
                proxy["name"] = f"{base_name} {i}"
                proxies.append(proxy)
            with open(os.path.join(folder, name), "w") as f:
                json.dump({"proxies": proxies}, f, indent=2)
            print(f"[cyan]Saved to {folder}/{name}[/cyan]")
        else:
            print("[red]Invalid option.[/red]")

        again = input("\n[magenta]Do you want to continue? (y/n):[/magenta] ").strip().lower()
        if again != "y":
            break

if __name__ == "__main__":
    main()

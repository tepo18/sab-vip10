import json
import re
import os
import yaml

def is_valid_uuid(uuid):
    return re.fullmatch(r'[0-9a-fA-F-]{36}', uuid) is not None

def detect_config_type(text):
    if text.startswith("vless://"):
        return "vless"
    elif text.startswith("vmess://"):
        return "vmess"
    elif text.startswith("trojan://"):
        return "trojan"
    elif text.startswith("ss://"):
        return "shadowsocks"
    elif '"protocol":"vless"' in text and '"vnext"' in text:
        return "json_vless"
    elif '"protocol":"vmess"' in text:
        return "json_vmess"
    elif '"protocol":"trojan"' in text:
        return "json_trojan"
    elif '"protocol":"shadowsocks"' in text:
        return "json_shadowsocks"
    elif '"protocol":"wireguard"' in text:
        return "json_wireguard"
    return "unknown"

def extract_json_blocks(text):
    return re.findall(r'{.*?"protocol"\s*:\s*".*?".*?}', text, re.DOTALL)

def convert_json_to_vless(js):
    try:
        cfg = json.loads(js)
        out = cfg.get("outbounds", [{}])[0]
        vnext = out.get("settings", {}).get("vnext", [{}])[0]
        user = vnext.get("users", [{}])[0]
        uuid = user.get("id", "")
        address = vnext.get("address", "")
        port = vnext.get("port", "")
        stream = out.get("streamSettings", {})
        net = stream.get("network", "tcp")
        sec = stream.get("security", "tls")
        sni = stream.get("tlsSettings", {}).get("serverName", "")
        fp = stream.get("tlsSettings", {}).get("fingerprint", "")
        path = ""
        if net == "ws":
            path = stream.get("wsSettings", {}).get("path", "")
        elif net == "grpc":
            path = stream.get("grpcSettings", {}).get("serviceName", "")
        if not (uuid and address and port and is_valid_uuid(uuid)):
            return None
        return f"vless://{uuid}@{address}:{port}?encryption=none&type={net}&security={sec}&sni={sni}&fp={fp}&path={path}#{address}"
    except:
        return None

def main():
    print("کانفیگ‌ها را وارد کنید (Ctrl+D برای پایان):\n")
    input_text = ""
    try:
        while True:
            line = input()
            input_text += line.strip() + "\n"
    except EOFError:
        pass

    configs = [line.strip() for line in input_text.strip().splitlines() if line.strip()]
    input_count = len(configs)

    detected = {
        "vless": [],
        "vmess": [],
        "trojan": [],
        "shadowsocks": [],
        "wireguard": [],
        "json_vless": [],
        "json_vmess": [],
        "json_trojan": [],
        "json_shadowsocks": [],
        "json_wireguard": [],
        "unknown": [],
        "errors": []
    }

    for line in configs:
        type_ = detect_config_type(line)
        if type_ in ["vless", "vmess", "trojan", "shadowsocks", "wireguard"]:
            detected[type_].append(line)
        elif type_.startswith("json_"):
            if type_ == "json_vless":
                result = convert_json_to_vless(line)
                if result:
                    detected["vless"].append(result)
                else:
                    detected["errors"].append(line)
            else:
                detected[type_].append(line)
        elif "outbounds" in line:
            blocks = extract_json_blocks(line)
            for block in blocks:
                result = convert_json_to_vless(block)
                if result:
                    detected["vless"].append(result)
                else:
                    detected["errors"].append(block)
        else:
            detected["unknown"].append(line)

    total_output = (detected["vless"] + detected["vmess"] + detected["trojan"] +
                    detected["shadowsocks"] + detected["wireguard"] +
                    detected["json_vmess"] + detected["json_trojan"] +
                    detected["json_shadowsocks"] + detected["json_wireguard"])

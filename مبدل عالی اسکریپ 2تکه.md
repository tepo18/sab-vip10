import os
import re
import subprocess
import base64
from rich import print
from rich.prompt import Prompt

protocols = ["vmess://", "vless://", "trojan://", "ss://"]

def extract_host(config):
    match = re.search(r"@([^:/?#]+)", config)
    return match.group(1) if match else None

def ping_host(host):
    try:
        output = subprocess.check_output(
            ["ping", "-c", "3", "-W", "1", host],
            stderr=subprocess.DEVNULL
        ).decode()
        match = re.search(r"rtt min/avg/max/mdev = [\d.]+/([\d.]+)", output)
        return float(match.group(1)) if match else None
    except:
        return None

def classify_ping(ping):
    if ping is None:
        return "bad", "[bold red][BAD][/bold red]"
    elif ping < 150:
        return "good", "[bold green][GOOD][/bold green]"
    elif ping < 300:
        return "warn", "[bold yellow][WARN][/bold yellow]"
    else:
        return "bad", "[bold red][BAD][/bold red]"

def save_output(choice, configs):
    folder = "/storage/emulated/0/Download/Akbar98"
    if not os.path.exists(folder):
        os.makedirs(folder)

    file_name = input("Enter file name to save (without extension): ").strip()
    if not file_name:
        file_name = "good_configs"

    if choice == "2":
        path = os.path.join(folder, file_name + ".txt")
        with open(path, "w") as f:
            for c in configs:
                f.write(c + "\n")
        print(f"[cyan]Saved TXT to {path}[/cyan]")

    elif choice == "4":
        path = os.path.join(folder, "clash_subscription.yaml")
        with open(path, "w") as f:
            f.write("proxies:\n")
            for c in configs:
                f.write(f"  - {c}\n")
        print(f"[cyan]Clash YAML saved to {path}[/cyan]")

    elif choice == "5":
        path = os.path.join(folder, "hiddify_subscription.txt")
        with open(path, "w") as f:
            for c in configs:
                f.write(c + "\n")
        print(f"[cyan]Hiddify subscription saved to {path}[/cyan]")

    elif choice == "6":
        path = os.path.join(folder, "v2ray_base64.txt")
        with open(path, "w") as f:
            for c in configs:
                f.write(base64.b64encode(c.encode()).decode() + "\n")
        print(f"[cyan]V2Ray base64 saved to {path}[/cyan]")

    elif choice == "7":
        full = base64.b64encode('\n'.join(configs).encode()).decode()
        path = os.path.join(folder, "subscription_encoded.txt")
        with open(path, "w") as f:
            f.write(full)
        print(f"[cyan]Full Base64 encoded saved to {path}[/cyan]")

def main():
    print("[bold cyan]Enter your configs line by line. When done, enter an empty line:[/bold cyan]")
    lines = []
    while True:
        line = input()
        if line.strip() == "":
            break
        lines.append(line.strip())

    good_configs = []

    for config in lines:
        if not any(config.startswith(p) for p in protocols):
            continue

        host = extract_host(config)
        if not host:
            print(f"[red][INVALID][/red] {config}")
            continue

        ping = ping_host(host)
        status, label = classify_ping(ping)
        print(f"{label} {host} - {ping if ping else 'NO REPLY'}ms")

        if status == "good":
            good_configs.append(config)

    if not good_configs:
        print("[bold red]No good configs found.[/bold red]")
        return

    while True:
        print("\n[bold green]Output options:[/bold green]")
        print("1) Show filtered configs here")
        print("2) Save filtered configs as TXT")
        print("4) Save filtered configs as Clash subscription (YAML)")
        print("5) Save filtered configs as Hiddify subscription (TXT)")
        print("6) Save filtered configs as V2Ray subscription (base64 line per config)")
        print("7) Save filtered configs as Base64 encoded subscription (all combined)")
        print("0) Exit")
        choice = input("[bold yellow]Enter number:[/bold yellow] ").strip()

if choice == "1":
            print("\nFiltered configs:")
            for conf in good_configs:
                print(conf)
        elif choice in ["2", "4", "5", "6", "7"]:
            save_output(choice, good_configs)
        elif choice == "0":
            break
        else:
            print("[red]Invalid choice[/red]")

if name == "main":
    main()

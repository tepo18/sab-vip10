from ping3 import ping
from colorama import Fore, Style, init
import os
import re

init(autoreset=True)

def extract_host_from_config(config):
    match = re.search(r'@([^\s:/]+)', config)
    if match:
        return match.group(1)
    match = re.search(r'://([^:/]+)', config)
    if match:
        return match.group(1)
    return None

def is_valid_ping(host):
    try:
        delay = ping(host, timeout=1)
        if delay is not None:
            return True
    except Exception:
        pass
    return False

def save_to_txt(path, data):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w') as f:
        for item in data:
            f.write(item + '\n')

def main():
    print(Fore.YELLOW + "Paste your configs (one per line). End with an empty line:" + Style.RESET_ALL)

    configs = []
    while True:
        line = input()
        if line.strip() == '':
            break
        configs.append(line.strip())

    print(Fore.CYAN + f"\nChecking {len(configs)} configs, please wait..." + Style.RESET_ALL)

    filtered = []
    for cfg in configs:
        host = extract_host_from_config(cfg)
        if host:
            if is_valid_ping(host):
                filtered.append(cfg)
                print(Fore.GREEN + f"Valid and responsive: {host}" + Style.RESET_ALL)
            else:
                print(Fore.RED + f"No response or invalid host: {host}" + Style.RESET_ALL)
        else:
            print(Fore.MAGENTA + "Could not extract host from config:" + Style.RESET_ALL, cfg)

    if not filtered:
        print(Fore.RED + "\nNo valid configs found!" + Style.RESET_ALL)
        return

    print(Fore.YELLOW + "\nChoose output option:\n"
          "1) Show filtered configs here\n"
          "2) Save filtered configs to txt file in Download folder\n"
          + Style.RESET_ALL)
    choice = input(Fore.CYAN + "Enter 1 or 2: " + Style.RESET_ALL)

    if choice == '1':
        print(Fore.GREEN + "\nFiltered configs:\n" + Style.RESET_ALL)
        for f in filtered:
            print(f)
    elif choice == '2':
        path_txt = '/storage/emulated/0/Download/Akbar98/txt/filtered_configs.txt'
        save_to_txt(path_txt, filtered)
        print(Fore.GREEN + f"Filtered configs saved to {path_txt}" + Style.RESET_ALL)
    else:
        print(Fore.RED + "Invalid choice!" + Style.RESET_ALL)
        return

    if choice == '2':
        final_choice = input(Fore.YELLOW + "\nDo you want to (1) view the saved file or (2) exit? Enter 1 or 2: " + Style.RESET_ALL)
        if final_choice == '1':
            try:
                with open(path_txt, 'r') as f:
                    content = f.read()
                print(Fore.GREEN + "\nContent of saved file:\n" + Style.RESET_ALL)
                print(content)
            except Exception as e:
                print(Fore.RED + f"Error reading file: {e}" + Style.RESET_ALL)
        else:
            print(Fore.CYAN + "Exiting..." + Style.RESET_ALL)
    else:
        print(Fore.CYAN + "Exiting..." + Style.RESET_ALL)

if __name__ == "__main__":
    main()

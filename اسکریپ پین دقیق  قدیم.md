import os
import re
import subprocess
from rich import print
from rich.prompt import Prompt

protocols = ["vmess://", "vless://", "trojan://", "ss://"]

def extract_host(config):
    match = re.search(r"@([^:/?#]+)", config)
    return match.group(1) if match else None

def ping_host(host):
    try:
        output = subprocess.check_output(
            ["ping", "-c", "3", "-W", "1", host],
            stderr=subprocess.DEVNULL
        ).decode()
        match = re.search(r"rtt min/avg/max/mdev = [\d.]+/([\d.]+)", output)
        return float(match.group(1)) if match else None
    except:
        return None

def classify_ping(ping):
    if ping is None:
        return "bad", "[bold red][BAD][/bold red]"
    elif ping < 150:
        return "good", "[bold green][GOOD][/bold green]"
    elif ping < 300:
        return "warn", "[bold yellow][WARN][/bold yellow]"
    else:
        return "bad", "[bold red][BAD][/bold red]"

def main():
    print("[bold cyan]Enter your configs line by line. When done, enter an empty line:[/bold cyan]")
    lines = []
    while True:
        line = input()
        if line.strip() == "":
            break
        lines.append(line.strip())

    good_configs = []

    for config in lines:
        if not any(config.startswith(p) for p in protocols):
            continue

        host = extract_host(config)
        if not host:
            print(f"[bold red][INVALID][/bold red] {config}")
            continue

        ping = ping_host(host)
        status, label = classify_ping(ping)
        print(f"{label} {host} - {ping if ping else 'NO REPLY'}ms")

        if status == "good":
            good_configs.append(config)

    if not good_configs:
        print("[bold red]No good configs found.[/bold red]")
        return

    while True:
        print("\nOutput options:")
        print("1) Show filtered configs here")
        print("2) Save filtered configs to /storage/emulated/0/Download/Akbar98/")
        choice = input("Enter 1 or 2: ").strip()

        if choice == "1":
            print("\nFiltered configs:")
            for conf in good_configs:
                print(conf)
            break

        elif choice == "2":
            folder = "/storage/emulated/0/Download/Akbar98"
            if not os.path.exists(folder):
                os.makedirs(folder)

            file_name = input("Enter file name to save (without extension): ").strip()
            if not file_name:
                file_name = "good_configs"

            file_path = os.path.join(folder, file_name + ".txt")
            i = 1
            while os.path.exists(file_path):
                file_path = os.path.join(folder, f"{file_name}_{i}.txt")
                i += 1

            with open(file_path, "w") as f:
                for conf in good_configs:
                    f.write(conf + "\n")

            print(f"[bold cyan]Filtered configs saved to {file_path}[/bold cyan]")
            break

        else:
            print("Invalid choice. Please enter 1 or 2.")

if __name__ == "__main__":
    main()
